from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils import executor
import os

API_TOKEN = os.getenv("BOT_TOKEN")

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

user_data = {}

professions = {
    'инженер': 0,
    'изобретатель': 0,
    'учитель': 0,
    'партийный деятель': 0,
    'писатель': 0,
    'артист': 0,
    'шахтёр': 0,
    'колхозник': 0,
    'врач': 0,
    'военный': 0,
    'учёный': 0,
    'фабричный рабочий': 0,
    'милиционер': 0,
    'лётчик': 0,
    'дипломат': 0
}

questions = [
    {
        "text": "Ты скорее...",
        "options": [
            ("Люблю изобретать и чинить", {"инженер": 2, "изобретатель": 1}),
            ("Общаюсь с людьми и руковожу", {"учитель": 2, "партийный деятель": 1}),
            ("Мечтаю и создаю искусство", {"писатель": 2, "артист": 1}),
            ("Работаю руками, мне не страшен труд", {"шахтёр": 2, "колхозник": 1}),
        ]
    },
    {
        "text": "Что тебе ближе по духу?",
        "options": [
            ("Создавать новые технологии", {"инженер": 2, "учёный": 1}),
            ("Помогать людям", {"врач": 2, "учитель": 1}),
            ("Служить стране", {"военный": 2, "милиционер": 1}),
            ("Творить на сцене или в книгах", {"артист": 2, "писатель": 1}),
        ]
    },
    {
        "text": "Какой стиль работы тебе ближе?",
        "options": [
            ("Стабильная и понятная", {"фабричный рабочий": 2, "колхозник": 1}),
            ("Полная неожиданностей", {"лётчик": 2, "военный": 1}),
            ("Связана с влиянием", {"партийный деятель": 2, "дипломат": 1}),
            ("Научная и исследовательская", {"учёный": 2, "изобретатель": 1}),
        ]
    },
    {
        "text": "Какая сфера тебе интереснее?",
        "options": [
            ("Промышленность", {"инженер": 2, "фабричный рабочий": 1}),
            ("Сельское хозяйство", {"колхозник": 2, "врач": 1}),
            ("Культура", {"писатель": 2, "артист": 1}),
            ("Политика и управление", {"дипломат": 2, "партийный деятель": 1}),
        ]
    }
]

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    user_data[message.from_user.id] = {"step": 0, "scores": professions.copy()}
    await send_question(message.from_user.id)

async def send_question(user_id):
    step = user_data[user_id]["step"]
    if step < len(questions):
        q = questions[step]
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        for option, _ in q["options"]:
            kb.add(KeyboardButton(option))
        await bot.send_message(user_id, q["text"], reply_markup=kb)
    else:
        await show_result(user_id)

@dp.message_handler()
async def handle_answer(message: types.Message):
    user_id = message.from_user.id
    step = user_data[user_id]["step"]
    q = questions[step]

    for option, scores in q["options"]:
        if message.text == option:
            for prof, pts in scores.items():
                user_data[user_id]["scores"][prof] += pts
            break

    user_data[user_id]["step"] += 1
    await send_question(user_id)

async def show_result(user_id):
    scores = user_data[user_id]["scores"]
    top_prof = max(scores, key=scores.get)
    history = {
        "инженер": "Инженеры XX века создавали технологии и строили заводы. Один из самых уважаемых и нужных людей эпохи.",
        "учитель": "Учителя были важнейшим звеном советского общества, формируя мышление будущих поколений.",
        "писатель": "Писатели создавали книги, пьесы, вдохновляли людей. Их слова имели силу менять общество.",
        "шахтёр": "Шахтёры работали в тяжелейших условиях, добывая уголь для развития страны.",
        "артист": "Артисты выступали на сценах, вдохновляя и объединяя людей даже в самые трудные времена.",
        "военный": "Военные защищали Родину и строили военную мощь СССР.",
        "учёный": "Учёные разрабатывали новейшие открытия, продвигая науку страны вперёд.",
        "партийный деятель": "Эти люди определяли курс страны и управляли её развитием.",
        "изобретатель": "Изобретатели находили нестандартные решения и создавали новые механизмы.",
        "фабричный рабочий": "Основная движущая сила индустриализации СССР.",
        "колхозник": "Работники сельского хозяйства, обеспечивающие продовольствием страну.",
        "милиционер": "Охраняли порядок и защищали граждан.",
        "лётчик": "Пилоты покоряли небо, доставляя грузы и сражаясь за страну.",
        "дипломат": "Представители страны на международной арене, отвечающие за переговоры и связи.",
        "врач": "Спасали жизни, лечили болезни и стояли на страже здоровья нации."
    }
    text = f"Ты — {top_prof.title()}!\n\n{history.get(top_prof, 'Интересная профессия XX века!')}"
    await bot.send_message(user_id, text, reply_markup=types.ReplyKeyboardRemove())

if __name__ == '__main__':
    executor.start_polling(dp)
